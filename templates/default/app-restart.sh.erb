#!/bin/bash
RETRIES=<%= @timeout %>
PORT=<%= @app_port %>

# FAILURE TIME TO DIE
function die_loudly {
  echo "**************** $@ ****************"
  exit 1
}

function say_loudly {
  echo "================ $@ ================"
}

# Let the app server finish any open requests
function finish_requests {
 <%= @finished_requests_command %>
}

# Is the app currently running
function app_running {
  <%= @app_running_command %> && echo
}

# Is the app ready to serve traffic
function app_ready {
  <%= @app_ready_command %>
}

# Wait until the app is running
function app_up {
  # Give the app *at least* a minute to boot
  for i in $(seq 1 $RETRIES)
  do
    app_running && return
    status=$?
    sleep 1
  done
  app_ready

  return $status
}

# Remove Instance from the load balancer
<%= "#{@bin_dir}/#{@remove_bin}" %>

# Allow open requests to finish
finish_requests

# Restart the application
say_loudly "ATTEMPTING to RESTART <%= node[:hostname] %>"
<%= @restart_command %>

# Wait for the app to come back up or fail the restart
app_up || die_loudly "RESTART FAILED <%= node[:hostname] %>"
say_loudly "RESTART COMPLETE <%= node[:hostname] %>"

# Add Instance back into the load balancer
<%= "#{@bin_dir}/#{@add_bin}" %>
