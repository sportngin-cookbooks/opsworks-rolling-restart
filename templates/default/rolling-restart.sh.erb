#!/bin/bash

# FAILURE TIME TO DIE
function die_loudly {
  echo "**************** $@ ****************"
  exit 1
}

function say_loudly {
  echo "================ $@ ================"
}

<% if node[:rolling_restart][:before_command] %>
function before_command {
  <%= node[:rolling_restart][:before_command] %>
}

<% end %>
<% if node[:rolling_restart][:after_command] %>
function after_command {
  <%= node[:rolling_restart][:after_command] %>
}

<% end %>
<%= "before_command" if node[:rolling_restart][:before_command] %>

instances=(<%= @ip_addresses.join(' ') %>)
instance_num=1
for i in ${instances[@]};do
  say_loudly "Starting Restart $instance_num of ${#instances[@]}"
  sudo -u <%= @user %> ssh <%= @user %>@$i <%= @app_restart_command %> || die_loudly "RESTART FAILED ON $i"
  say_loudly "Finished Restart $instance_num of ${#instances[@]}"
  ((instance_num++))
done

<%= "after_command" if node[:rolling_restart][:after_command] %>
